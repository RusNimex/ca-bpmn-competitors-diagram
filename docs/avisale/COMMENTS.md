# Комментарии к решению задания по сверке (Авиасейлс)

## Постановка задачи

Нужно было сравнить два источника за один период:
- **Итоговый отчёт продавца** (`revise_rep_09_01-15.csv`) — что партнёр готов выплатить;
- **Наша БД** (`revise_stats_09_01-15.csv`) — что мы записали по данным в реальном времени.

Цель: выявить расхождения и подготовить понятное письмо продавцу с просьбой дать разъяснения.

---

## Инструменты и подход

### 1. Разведка структуры данных

- **Read** — просмотр первых строк обоих CSV, чтобы понять заголовки и форматы.
- **Grep** — поиск типов операций (SALE / REFUND) и проверка, что в отчёте продавца есть и продажи, и возвраты.

**Выводы по структуре:**
- Отчёт продавца: колонки «Номера заказа», «Дата сделки», «Вид операции» (SALE/REFUND), «Price», «CPA», «CPA, руб.»; числа в формате с запятой как разделителем тысяч (например, `"-2,584.32"`).
- Наша выгрузка: `order_number`, `booked_at`, `state` (paid/cancelled), `price_amount`, `profit_amount` (наша комиссия в рублях).
- Ключ для сопоставления — **номер заказа**. У продавца по одному заказу может быть несколько строк (SALE + несколько REFUND), поэтому по каждому заказу нужно **суммировать** «CPA, руб.».

### 2. Парсинг числовых полей

В отчёте продавца числа вида `"-2,584.32"` или `373.56`. Решение: убрать пробелы и запятые (запятая — тысячи), затем `float()`. Так получаем и отрицательные (возвраты), и положительные (продажи) суммы.

### 3. Выбор колонки «CPA, руб.» в отчёте продавца

В заголовке есть и «CPA» (ставка), и «CPA, руб.» (сумма). При разборе CSV из-за завершающей запятой в строках последнее значение часто попадало в пустую колонку, а сумма в рублях оказывалась в **предпоследней** колонке (индекс 10). В коде зафиксирована логика: ищем колонку с «руб» и «CPA», при необходимости используем индекс 10 для данных этого файла.

### 4. Скрипт сверки (Python)

- **csv** — корректный разбор CSV с кавычками и запятыми внутри полей.
- **pathlib** — пути к файлам рядом со скриптом.
- **defaultdict(float)** — суммирование «CPA, руб.» по номеру заказа в отчёте продавца.
- Сравнение: для каждого номера заказа сравниваются сумма у продавца и `profit_amount` у нас; допуск 0.02 руб. на округление.
- Классификация расхождений: заказы только у продавца / только у нас / совпадают по номеру, но различается сумма; внутри последних — мелкие (до 1 руб.) и существенные.

Скрипт запускался в WSL (`python3 reconcile.py`), так как в среде Windows Python не был доступен в PATH.

### 5. Письмо продавцу

Использован вывод скрипта (сводка и примеры). Текст письма:
- без обвинений, нейтральный тон;
- два блока: «заказы, которых нет в вашем отчёте» и «расхождения по сумме по заказам»;
- конкретные вопросы: почему заказы не попали в отчёт, как считаются комиссия и возвраты;
- просьба прислать разъяснения или уточнённую выгрузку.

---

## Основные выводы по результатам сверки

1. **Итоги не сходятся:** у нас сумма больше на ~7,3 млн руб. (у продавца ~18,6 млн, у нас ~26,0 млн).
2. **Главная причина — отсутствующие в отчёте продавца заказы:** 11 368 заказов есть в нашей базе (приходили в реалтайме), но их нет в итоговом отчёте партнёра; сумма по ним ~7,4 млн руб. Это может быть из-за выгрузки (дата, фильтры), дубликатов, отмен или другой внутренней логики учёта у продавца.
3. **Расхождения по сумме по отдельным заказам:** 163 заказа, из них 118 с заметной разницей. Возможные причины: разное округление, разный учёт частичных возвратов или сроков признания операций.
4. **Заказов «только у продавца»** (есть в его отчёте, нет у нас) — 0, то есть мы не теряли заказы на своей стороне по этому сравнению.

Дальнейшие шаги — диалог с продавцом по письму, уточнение выгрузок и правил учёта, при необходимости — донастройка реалтайм-интеграции или формата месячного отчёта, чтобы следующие сверки проходили без таких расхождений.
