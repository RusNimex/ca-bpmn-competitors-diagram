# Бизнес требования

Цель: обеспечить стабильные онлайн‑продажи билетов 24/7 и снизить нагрузку на кассы за счет самостоятельной покупки пользователями.

## Бизнес-правила и ограничения

| ID | Правило |
|----|---------|
| BR-001 | Соблюдать возрастной ценз. Например, билеты на фильмы 18+ могут приобретать только совершеннолетние. |
| BR-002 | Конфигурации и количества залов у каждого кинотеатра свои. |
| BR-003 | Отмена покупки невозможна за 10 минут до начала сеанса. |
| BR-004 | Нельзя допускать продажи одних и тех же мест. |
| BR-005 | Билет должен быть связан с Покупателем. |

## Роли

| Роль | Описание |
|------|----------|
| **Покупатель** | Любой желающий |
| **Система оплаты** | Внешний API для оплаты |
| **Сервис уведомлений** | Отправка SMS со ссылкой на билет |

# Пользовательские требования

| ID | Требование |
|----|------------|
| UR-001 | Поиск фильма по названию, времени, жанру. |
| UR-002 | Информация о фильме и его расписание. |
| UR-003 | План зала, свободные места и стоимость. |
| UR-004 | Оплата билетов по безналичному расчёту. |
| UR-005 | Просмотр истории покупок. |
| UR-006 | Отмена покупки. |

# Функциональные требования

| ID | Требование |
|----|------------|
| FR-001 | Предоставить информацию о фильме, кинотеатре, расписании, свободных местах и стоимости. |
| FR-002 | Места, которые выбрал Покупатель, должны бронироваться. |
| FR-003 | Время бронирования мест: 10 минут. |
| FR-004 | Забронированные места должны быть недоступны для покупки, пока их не оплатят или не выйдет время таймера. |
| FR-005 | Купленные места должны быть заблокированы для других Покупателей. |
| FR-006 | По окончании времени, отведённого Покупателю, нужно обновить данные зала и начать отсчёт заново. |
| FR-007 | Время на оплату ограничено — 5 минут. |
| FR-008 | Оплаченные билеты нельзя отменить за 10 минут до начала сеанса. |
| FR-009 | Отправить билет (код билета) только после подтверждения оплаты банком. |
| FR-010 | Подтверждение возраста, если есть ценз. |
| FR-011 | Запоминать Покупателя и его номер телефона. |
| FR-012 | История покупок Покупателя. |
| FR-013 | Уведомления о покупке (SMS). |

# Нефункциональные требования

| ID | Требование |
|----|------------|
| NFR-001 | Доступность должна быть на уровне 99,5% по времени бизнеса 9–21. |
| NFR-002 | Производительность: поиск < 500 ms p95, покупка < 2 сек с p95. |
| NFR-003 | Безопасность: PCI-DSS для платежей (не храним данные карты), защита PII для ПДн (шифрование телефона). |
| NFR-004 | Логируемость (поиск, резерв, покупка, выдача) и трассировка критических операций (сквозное отслеживание запроса). |
| NFR-005 | Система должна хранить данные Покупателя в соответствии с требованиями к ПДн. |

# Ограничения

| ID | Ограничение |
|----|-------------|
| CON-001 | Все платежи идут через внешнего провайдера. |
| CON-002 | Схема зала фиксированная и не меняется часто. |

# Диаграмма последовательности (Sequence-diagram)

- [sequence.puml](diagramm/sequence.puml) — каталог/поиск, просмотр фильма и мест, бронирование (10 мин), оплата (5 мин), webhook, выдача билетов.

# Use Case диаграмма

- [usecases.puml](diagramm/usecases.puml) — поиск, расписание, выбор мест, оплата, история, отмена.

# Диаграммы активности (Activity-diagram)

- [activity.puml](diagramm/activity.puml) — по UR/FR: поиск и расписание (UR-001, UR-002), выбор мест и бронирование (UR-003), оплата и выдача (UR-004), история (UR-005), отмена (UR-006).

# Тест-кейсы

Таблица: ID, название, предусловия, шаги, ожидаемый результат, трассировка к UR/FR. Отдельные схемы не нужны — тест-кейсы ссылаются на [sequence.puml](diagramm/sequence.puml) и [activity.puml](diagramm/activity.puml).

| TC-ID | Название | Предусловия | Шаги | Ожидаемый результат | UR/FR |
|-------|----------|-------------|------|---------------------|-------|
| TC-001 | Поиск по жанру | Каталог с фильмами | 1. Открыть каталог 2. Фильтр: жанр «боевик» | Список фильмов жанра «боевик» | UR-001 |
| TC-002 | Пустой результат поиска | Каталог с фильмами | 1. Ввести несуществующее название | «Ничего не найдено» | UR-001 |
| TC-003 | Просмотр расписания | Фильм в каталоге | 1. Выбрать фильм | Детали фильма и список сеансов | UR-002, FR-001 |
| TC-004 | План зала и места | Сеанс с местами | 1. Выбрать сеанс | План зала, свободные места, цены | UR-003, FR-001 |
| TC-005 | Бронирование мест | Свободные места | 1. Выбрать места 2. POST /reservations | 200 OK, reservationId, таймер 10 мин | UR-003, FR-002, FR-003 |
| TC-006 | Бронирование занятых мест | Места уже заняты | 1. Выбрать места другого покупателя 2. POST /reservations | 409 Conflict (BR-004) | BR-004 |
| TC-007 | Оплата и выдача билета | Бронирование активно | 1. POST /orders 2. Оплата в виджете 3. Webhook подтверждение | Билет выдан, SMS со ссылкой | UR-004, FR-009, FR-013 |
| TC-008 | Таймаут бронирования | Бронь 10+ минут назад | 1. Попытка оплатить старую бронь | Места освобождены, ошибка | FR-006, FR-007 |
| TC-009 | Просмотр истории | Покупатель с покупками | 1. Открыть «Мои покупки» | Список заказов с билетами | UR-005, FR-012 |
| TC-010 | Отмена до 10 минут | До сеанса > 10 мин | 1. Отменить заказ | Отмена выполнена, возврат средств | UR-006 |
| TC-011 | Отмена запрещена | До сеанса < 10 мин | 1. Нажать «Отменить» | «Отмена невозможна» (BR-003) | UR-006, FR-008, BR-003 |
| TC-012 | Возрастной ценз 18+ | Фильм 18+, пользователь не подтвердил возраст | 1. Выбрать билет на 18+ | Запрос подтверждения возраста | BR-001, FR-010 |

# Контракты и интеграции

- [OpenAPI (Swagger)](openapi.yaml) — описание эндпоинтов по sequence.puml и SRS.

# Модель данных (ER-diagram)

- [Концептуальная модель](diagramm/erd.dbd)

# Телеметрия

Мониторинг работоспособности приложения и внешних интеграций (платёжная система) — для обнаружения сбоев и своевременного реагирования. Логирование и трассировка — NFR-004.

## Проверка доступности платёжной системы

| Подход | Описание | Плюсы | Минусы |
|--------|----------|-------|--------|
| **Health check (ping)** | Периодический запрос к health-эндпоинту провайдера. Интервал: 1 мин. | Простота, быстрое обнаружение сбоя | Нагрузка на API провайдера, возможный rate limit |
| **Synthetic transaction** | Периодическая тестовая оплата в sandbox. | Реалистичная проверка всего пути | Сложнее, зависит от sandbox провайдера |
| **Passive monitoring** | Анализ реальных запросов: 5xx/таймауты подряд → алерт | Нет доп. нагрузки | Сбой виден только при попытке оплаты |
| **Circuit breaker** | При падении health check — режим «платежи недоступны», уведомление в UI | Пользователь сразу видит статус | Требует health check |

**Рекомендация:** Health check раз в 1 минуту к `/health` или `/ping` провайдера. При недоступности — алерт (Slack/PagerDuty), при 3+ провалах подряд — circuit breaker и отображение «Платёжная система временно недоступна» (sequence: Pay API unavailable). Интеграция с NFR-004 (логирование, трассировка).

