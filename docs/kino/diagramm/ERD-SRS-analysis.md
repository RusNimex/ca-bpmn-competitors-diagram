# Анализ соответствия ERD (erd.dbd) документу SRS (SRS.md)

## 1. Обзор модели данных в ERD

**Таблицы:**
- `film` — фильм
- `brand` — бренд (сеть кинотеатров)
- `brand_hall` — тип/конфигурация зала у бренда
- `brand_hall_room` — зал (комната) в привязке к бренду и конфигурации
- `brand_hall_room_schedule` — расписание сеансов (зал + фильм + время)
- `brand_hall_room_seat_film_price` — место на сеансе и его цена
- `сustomer` — покупатель (в диаграмме имя с кириллической «с»: **сustomer**)
- `customer_orders` — заказ покупателя (связь с местами и покупателем)
- `customer_order_payment` — оплата заказа

**Связи:**
- brand_hall → brand  
- brand_hall_room → brand_hall  
- brand_hall_room_schedule → brand_hall_room, film  
- brand_hall_room_seat_film_price → brand_hall_room_schedule  
- customer_orders → brand_hall_room_seat_film_price, сustomer  
- customer_order_payment → customer_orders  

---

## 2. Соответствие требованиям SRS

### 2.1. Бизнес-правила и ограничения

| Требование SRS | Соответствие ERD | Комментарий |
|----------------|------------------|-------------|
| Возрастной ценз (18+) | ⚠ Частично | Нужно поле возраста/рейтинга: в `film` — рейтинг (age_rating), для проверки при покупке. В ERD состав полей не задан — необходимо добавить в модель. |
| Конфигурации и количества залов у каждого кинотеатра свои | ✅ | Иерархия brand → brand_hall → brand_hall_room поддерживает разные конфигурации залов. |
| Отмена покупки невозможна за 10 минут до сеанса | ⚠ Частично | Нужно хранить время начала сеанса (в `brand_hall_room_schedule`) и статус заказа. В ERD связи есть; атрибуты (в т.ч. время сеанса, статус заказа) в .dbd не описаны. |
| Нельзя продавать одни и те же места | ✅ | Один заказ привязан к конкретному месту (`brand_hall_room_seat_film_price_id`). Уникальность продажи одного места обеспечивается связью customer_orders → brand_hall_room_seat_film_price и бизнес-логикой/ограничениями (одно место — один оплаченный заказ). |
| Билет связан с Покупателем | ✅ | customer_orders связана с `сustomer`; заказ = выбранные места и, по смыслу, билет(ы). |

### 2.2. Роли и сущности

| Сущность SRS | В ERD | Комментарий |
|--------------|--------|-------------|
| Покупатель | `сustomer` | Есть; имя таблицы с кириллической «с» лучше привести к `customer`. |
| Система оплаты | Внешний API | В модели есть только факт оплаты: `customer_order_payment` (внешний провайдер не хранится в ERD — нормально). |
| Сервис уведомлений | Не в ERD | Внешний сервис; в ERD хранить не обязательно. Для SMS нужен телефон покупателя — см. п. 2.4. |

### 2.3. Пользовательские и функциональные требования (данные)

| Требование SRS | Поддержка в ERD | Комментарий |
|----------------|-----------------|-------------|
| Поиск фильма по названию, времени, жанру | ⚠ Частично | Есть `film` и `brand_hall_room_schedule`. В модели нужно предусмотреть атрибуты: название, жанр(ы) в `film`, время (и дата) в расписании. |
| Информация о фильме и расписание | ✅ | film + brand_hall_room_schedule. |
| План зала, свободные места, стоимость | ✅ | Места и цена: `brand_hall_room_seat_film_price`. Свободно/занято — через отсутствие/наличие оплаченного заказа по этому месту (или статус в заказе). |
| Оплата билетов, история покупок | ✅ | customer_orders + customer_order_payment; история = заказы по customer_id. |
| Бронирование мест (10 мин), недоступность забронированных до оплаты/истечения таймера | ⚠ Частично | Заказ может трактоваться как бронирование. Для «10 минут» и «недоступность» нужны: время создания заказа и статус (например reserved / paid / expired). В ERD таблицы есть, атрибуты (created_at, status) в .dbd не видны. |
| Время на оплату 5 минут | ⚠ Частично | Реализуется полями в customer_orders/customer_order_payment (время создания, статус). |
| Код билета только после подтверждения оплаты | ⚠ Частично | Нужно поле «код билета» (ticket_code) там, где фиксируется выдача билета — например в customer_orders или customer_order_payment после подтверждения. В ERD сущности под это есть, атрибуты не заданы. |
| Подтверждение возраста при цензе | ⚠ Частично | Требуются age_rating у фильма и возможность хранить/проверять возраст покупателя (например дата рождения в `сustomer`). |
| Запоминаем Покупателя и номер телефона | ⚠ Частично | Таблица `сustomer` есть; в модели нужно явно предусмотреть телефон (и при необходимости шифрование — см. ПДн). |
| Уведомления (SMS) | ⚠ Частично | Зависит от наличия телефона у покупателя в `сustomer`. |

### 2.4. Нефункциональные требования (данные и безопасность)

| Требование SRS | Соответствие ERD | Комментарий |
|----------------|------------------|-------------|
| PCI-DSS: не храним данные карты | ✅ | Оплата через провайдера; в ERD только факт оплаты (customer_order_payment), что согласуется с требованием. |
| Защита PII/ПДн, шифрование телефона | ⚠ Частично | В ERD должна быть сущность покупателя с телефоном; в анализе модели нужно зафиксировать, что телефон — ПДн и хранится в зашифрованном виде. |
| Хранение данных Покупателя по ПДн | ⚠ Частично | Таблица покупателя есть; состав полей и политика хранения в .dbd не описаны. |

### 2.5. Ограничения

| Требование SRS | В ERD |
|----------------|--------|
| Платежи через внешнего провайдера | ✅ Не противоречит (оплата как отдельная сущность, без карт). |
| Схема зала фиксированная | ✅ Поддерживается: места заданы через brand_hall_room_seat_film_price (и иерархия залов). |

---

## 3. Замечания и рекомендации

### 3.1. Критичные

1. **Имя таблицы `сustomer`**  
   В DbOid используется кириллическая «с»: `сustomer`. Для кода и БД лучше единое латинское имя `customer`, иначе возможны ошибки в запросах и миграциях.

2. **Явная модель «билета»**  
   SRS: «Отправить билет (код билета) только после подтверждения оплаты». Сейчас билет можно трактовать как оплаченную запись в customer_orders (или связку заказ + место). Рекомендация: в схеме БД явно предусмотреть поле кода билета (ticket_code) и момент его проставления (после подтверждения оплаты), например в `customer_orders` или в отдельной таблице ticket, связанной с заказом/местом.

3. **Бронирование и таймауты**  
   Для правил «10 минут брони», «5 минут на оплату» и «не продавать одни и те же места» в модели должны быть:
   - время создания заказа (created_at),
   - статус заказа (например: reserved, paid, expired, cancelled),
   - время начала сеанса (в расписании).  
   В erd.dbd перечень атрибутов не задан — эти поля нужно явно зафиксировать в спецификации схемы.

### 3.2. Желательные

4. **Фильм**  
   В `film` предусмотреть атрибуты: название, жанр(ы), возрастной рейтинг (age_rating).

5. **Расписание**  
   В `brand_hall_room_schedule`: дата и время начала (и при необходимости окончания) сеанса.

6. **Покупатель**  
   В `сustomer`: идентификатор, телефон (с учётом ПДн/шифрования), при необходимости дата рождения для возрастного ценза.

7. **Оплата**  
   В `customer_order_payment`: статус (pending, confirmed, failed), внешний идентификатор платежа (id от провайдера), время подтверждения.

8. **Документирование полей**  
   Файл erd.dbd не содержит определений столбцов. Имеет смысл вести отдельный артефакт (SQL DDL или описание модели данных), где перечислены все таблицы и атрибуты, чтобы проверить полное соответствие SRS (включая возрастной ценз, бронирование, код билета, ПДн).

---

## 4. Итоговая оценка

| Аспект | Оценка |
|--------|--------|
| Структура сущностей (фильм, залы, расписание, места, заказ, оплата, покупатель) | ✅ Соответствует |
| Связь билета/заказа с покупателем | ✅ Соответствует |
| Поддержка «одно место — одна продажа» и конфигураций залов | ✅ Соответствует |
| Отражение в ERD атрибутов (поля, типы, ограничения) | ⚠ В .dbd не описаны — нужна отдельная спецификация |
| Возрастной ценз, бронирование, код билета, ПДн/телефон | ⚠ Требуют явного введения/проверки атрибутов в модели данных |

**Вывод:** ERD по составу таблиц и связей в целом соответствует SRS и покрывает фильмы, кинотеатры/залы, расписание, места, заказы, оплату и покупателя. Для полного соответствия SRS нужно: (1) зафиксировать в модели данных перечень атрибутов (в т.ч. возрастной рейтинг, время сеанса, статусы заказа и оплаты, код билета, телефон/ПДн); (2) исправить имя таблицы на `customer`; (3) при необходимости явно ввести сущность/поля для билета и бронирования.
