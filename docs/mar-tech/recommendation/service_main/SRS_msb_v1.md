# Модуль импорта МСБ (Малый и средний бизнес)

**Версия:** 1.0 | **Дата:** 12-03-2025

---

**Проблема:** Рекомендации на основе текущей базы нерелевантны.  
**Решение:** Импорт данных российских компаний из 2GIS (CSV) — насыщение системы для релевантных рекомендаций и апсейла.  
**Кто использует:** Сотрудник (RBAC role ≥ employee).  
**Главный сценарий:** Загрузка CSV → выбор индустрии → асинхронная обработка → статистика → сопоставление → добавление на дашборд МСБ.

> Обзор: [README.md](README.md)

---

## 1. Область действия

Модуль входит в систему рекомендаций конкурентов. Источник — выгрузка 2GIS (CSV, UTF-8). Данные идут в отдельную базу МСБ и используются стратегией 3 (algo=MSB) — [service_rest/v2/SRS_v2.md](../service_rest/v2/SRS_v2.md).

**Ограничения:**
- Файл до 500 МБ, один за раз
- Индустрия выбирается до загрузки
- Социальные аккаунты без ID в Social → «битые», не учитываются

---

## 2. Сценарии использования

### UC-1. Загрузка CSV
1. Открыть импорт → выбрать индустрию → выбрать файл → «Загрузить»
2. Редирект на страницу прогресса
3. Файл обрабатывается в фоне; отображаются прогресс, счётчик аккаунтов, ошибки (битые категории)
4. *Ошибка:* нет файла/индустрии → валидация; файл >500 МБ → отказ

### UC-2. Сопоставление аккаунтов
1. Раздел «Статистика» → сводка по соцсетям (новые / сопоставленные)
2. «Сопоставить» → проверка загруженных аккаунтов на наличие в системе по ID соцсети

### UC-3. Добавление на дашборд МСБ
1. «Добавить на дашборд МСБ»
2. Получение ID через Social API → добавление к служебному пользователю МСБ
3. Не найден ID → аккаунт «битый», исключается

---

## 3. Требования

### Функциональные (FR)

| ID | Требование |
|----|------------|
| FR-001 | CSV до 500 МБ, асинхронная обработка, без блокировки UI |
| FR-002 | Прогресс на странице загрузки (обновление в реальном времени) |
| FR-003 | Запись в БД без дубликатов, транзакциями, батчами |
| FR-004 | Валидация (файл, индустрия) → понятные ошибки |
| FR-005 | Подкатегория >150 символов или общая строка >553 символов → битая категория; обрезка последнего элемента при >553; лог + отображение на странице |
| FR-006 | Аккаунт без ID в Social → «битый», не в статистике |
| FR-007 | Форма: файл + индустрия; страница загрузки: прогресс, аккаунты, ошибки |
| FR-008 | Статистика: соцсети, новые/сопоставленные; панель: «Сопоставить», «Добавить на дашборд», «Добавить индустрию» |
| FR-009 | Сущности: компании, категории, подкатегории, аккаунты, регион, район, город, район города |
| FR-017 | Сопоставление — проверка аккаунтов по ID соцсети в системе |
| FR-018 | Добавление аккаунтов к служебному пользователю МСБ (дашборд) |

### Нефункциональные (NFR)

- **NFR-001** — Сервер принимает файлы до 500 МБ
- **NFR-002** — Прогресс: backend пишет в Yii Cache каждые 100 строк или 1 сек; frontend опрашивает msb/checkImportProgress каждые 2 сек
- **NFR-003** — Доступ только для role ≥ employee
- **NFR-004** — Логирование битых категорий и аккаунтов

### Бизнес-правила (BR)

- **BR-001** — Загрузка только через админку
- **BR-002** — Один файл за операцию
- **BR-003** — Индустрии заданы заранее; выбор обязателен
- **BR-004** — Данные в отдельной базе МСБ

---

## 4. Интеграции

- **Social API** — получение ID аккаунта; при неудаче → битый
- **Yii Cache** — хранение прогресса импорта (import_id); бэкенд — Redis/File
- **Формат входа** — CSV UTF-8, структура 2GIS

---

## 5. Допущения

- Выгрузка 2GIS стабильна по структуре
- Social API доступен; сбои = битые аккаунты
- Служебный пользователь МСБ и дашборд созданы заранее

---

## 6. Тест-кейсы

| TC-ID | Название | Предусловия | Шаги | Ожидаемый результат | FR/UC |
|-------|----------|-------------|------|---------------------|-------|
| TC-001 | Загрузка без файла | Индустрии в системе | 1. Выбрать индустрию 2. Не выбирать файл 3. «Загрузить» | Ошибка валидации, понятный текст | FR-004, UC-1 |
| TC-002 | Загрузка без индустрии | — | 1. Выбрать файл 2. Не выбирать индустрию 3. «Загрузить» | Ошибка валидации, понятный текст | FR-004, UC-1 |
| TC-003 | Файл >500 МБ | Файл >500 МБ | 1. Выбрать индустрию и файл 2. «Загрузить» | Отказ, сообщение о превышении лимита | FR-001, UC-1 |
| TC-004 | Успешная загрузка | Корректный CSV, индустрия выбрана | 1. Выбрать индустрию и файл 2. «Загрузить» 3. Наблюдать страницу прогресса | Редирект, прогресс обновляется, по завершении — счётчик аккаунтов и ошибки | FR-001, FR-002, FR-007, UC-1 |
| TC-005 | Асинхронность | Идёт загрузка | 1. Инициировать новую загрузку | Новая задача принята, UI не заблокирован | FR-001 |
| TC-006 | Битые категории | CSV с категорией >532 символов | 1. Загрузить файл 2. Дождаться завершения | Обрезка по последней запятой; ошибки на странице; запись в лог «битые категории» | FR-005 |
| TC-007 | Статистика после загрузки | Загрузка завершена | 1. Открыть «Статистика» | Соцсети, кол-во новых/сопоставленных аккаунтов | FR-008, UC-2 |
| TC-008 | Сопоставление аккаунтов | Есть новые аккаунты | 1. «Сопоставить» | Проверка по ID соцсети; обновлённая статистика | FR-017, UC-2 |
| TC-009 | Добавление на дашборд МСБ | Есть несопоставленные аккаунты | 1. «Добавить на дашборд МСБ» | ID через Social → аккаунты на дашборде; без ID → битые, не в статистике | FR-006, FR-018, UC-3 |
| TC-010 | Доступ без роли employee | Пользователь с role &lt; employee | 1. Открыть раздел импорта МСБ | Доступ запрещён | NFR-003 |

---

## Термины

| Термин | Определение |
|--------|-------------|
| **МСБ** | Малый и средний бизнес |
| **2GIS** | Справочник компаний с категориями и соцсетями |
| **Индустрия** | Классификатор; выбирается перед загрузкой |
| **База МСБ** | Хранилище: компании, категории, подкатегории, аккаунты, регион, район, город, район города |
| **Сопоставление** | Связка аккаунта CSV с аккаунтом в системе по ID соцсети |
| **Битый аккаунт** | Нет ID в Social → исключается |
| **Битые категории** | Подкатегория >150 символов или общая строка >553; обрезка последнего элемента (FR-005) |
